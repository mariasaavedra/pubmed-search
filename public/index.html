<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PubMed Article Search</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f8f9fa;
        color: #333;
      }

      h1 {
        color: #2c3e50;
        margin-bottom: 30px;
        text-align: center;
      }

      .search-container {
        background-color: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }

      label {
        display: block;
        margin-bottom: 10px;
        font-weight: bold;
      }

      select {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
        margin-bottom: 20px;
      }

      button {
        background-color: #3498db;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s;
      }

      button:hover {
        background-color: #2980b9;
      }

      .results-container {
        background-color: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .article {
        margin-bottom: 25px;
        padding-bottom: 25px;
        border-bottom: 1px solid #eee;
      }

      .article:last-child {
        border-bottom: none;
      }

      .article h3 {
        margin-top: 0;
        color: #2c3e50;
      }

      .article p {
        margin: 8px 0;
        line-height: 1.5;
      }

      .article-meta {
        font-size: 14px;
        color: #7f8c8d;
      }

      .article-abstract {
        margin-top: 8px;
      }

      .loading {
        text-align: center;
        padding: 20px;
        display: none;
      }

      .error {
        background-color: #ffdddd;
        color: #a94442;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
        display: none;
      }

      .badge {
        display: inline-block;
        padding: 4px 8px;
        background-color: #ecf0f1;
        color: #7f8c8d;
        border-radius: 4px;
        font-size: 12px;
        margin-right: 5px;
        margin-bottom: 5px;
      }

      .journal-info {
        font-style: italic;
        margin-bottom: 8px;
      }

      .pagination {
        display: flex;
        justify-content: center;
        margin-top: 20px;
      }

      .pagination button {
        margin: 0 5px;
        background-color: #f1f1f1;
        color: #333;
      }

      .pagination button.active {
        background-color: #3498db;
        color: white;
      }

      .pagination button:disabled {
        background-color: #ddd;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <h1>PubMed Article Search by Specialty</h1>

    <div class="search-container">
      <label for="specialty">Select a medical specialty:</label>
      <select id="specialty">
        <option value="">-- Select a specialty --</option>
        <option value="cardiology">Cardiology</option>
        <option value="internalmedicine">Internal Medicine</option>
      </select>

      <button id="search-btn">Search Articles</button>
    </div>

    <div id="query"></div>

    <div class="error" id="error-message"></div>

    <div class="loading" id="loading">
      <p>Loading articles...</p>
    </div>

    <div class="results-container" id="results">
      <h2>Search Results</h2>
      <div id="articles-container"></div>

      <div class="pagination" id="pagination">
        <button id="prev-btn" disabled>Previous</button>
        <span id="page-info">Page 1</span>
        <button id="next-btn">Next</button>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Elements
        const specialtySelect = document.getElementById("specialty");
        const searchBtn = document.getElementById("search-btn");
        const articlesContainer = document.getElementById("articles-container");
        const queryContainer = document.getElementById("query");
        const loading = document.getElementById("loading");
        const errorMessage = document.getElementById("error-message");
        const results = document.getElementById("results");
        const prevBtn = document.getElementById("prev-btn");
        const nextBtn = document.getElementById("next-btn");
        const pageInfo = document.getElementById("page-info");

        // Hide results initially
        results.style.display = "none";

        // Pagination state
        let currentPage = 1;
        let totalPages = 1;

        // Load specialties from API
        fetch("/api/specialties")
          .then((response) => response.json())
          .then((data) => {
            // Clear dropdown
            specialtySelect.innerHTML =
              '<option value="">-- Select a specialty --</option>';

            // Add specialties to dropdown
            if (data && data.specialties && Array.isArray(data.specialties)) {
              data.specialties.forEach((specialty) => {
                const option = document.createElement("option");
                option.value = specialty;
                option.textContent =
                  specialty.charAt(0).toUpperCase() + specialty.slice(1);
                specialtySelect.appendChild(option);
              });
            } else {
              // Fallback to hardcoded specialties if API doesn't return expected format
              ["cardiology", "internal medicine"].forEach((specialty) => {
                const option = document.createElement("option");
                option.value = specialty;
                option.textContent =
                  specialty.charAt(0).toUpperCase() + specialty.slice(1);
                specialtySelect.appendChild(option);
              });
            }
          })
          .catch((error) => {
            console.error("Error fetching specialties:", error);
            showError("Failed to load specialties. Please refresh the page.");
          });

        // Search button click handler
        searchBtn.addEventListener("click", function () {
          searchArticles(1);
        });

        // Pagination button handlers
        prevBtn.addEventListener("click", function () {
          if (currentPage > 1) {
            searchArticles(currentPage - 1);
          }
        });

        nextBtn.addEventListener("click", function () {
          if (currentPage < totalPages) {
            searchArticles(currentPage + 1);
          }
        });

        function searchArticles(page) {
          const specialty = specialtySelect.value;

          if (!specialty) {
            showError("Please select a specialty");
            return;
          }

          // Show loading, hide results and errors
          loading.style.display = "block";
          results.style.display = "none";
          errorMessage.style.display = "none";

          // Update current page
          currentPage = page;

          // Show loading indicator
          console.log("Searching for articles in specialty:", specialty);

          // Make API request
          fetch(`/api/articles/specialty?page=${page}&limit=10`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ specialty }),
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error("Network response was not ok");
              }
              return response.json();
            })
            .then((data) => {
              displayResults(data);
            })
            .catch((error) => {
              console.error("Error fetching articles:", error);
              showError("Failed to load articles. Please try again later.");
            })
            .finally(() => {
              loading.style.display = "none";
            });
        }

        function displayResults(data) {
          // Clear previous results

          articlesContainer.innerHTML = "";

          console.log(data);
          // If no articles found
          if (!data.articles || data.articles.length === 0) {
            articlesContainer.innerHTML =
              "<p>No articles found for this specialty.</p>";
            results.style.display = "block";
            return;
          }

          // Update pagination info
          totalPages = Math.ceil(data.total / data.limit) || 1;
          pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
          prevBtn.disabled = currentPage <= 1;
          nextBtn.disabled = currentPage >= totalPages;

          // Display articles
          data.articles.forEach((article) => {
            const articleElement = document.createElement("div");
            articleElement.className = "article";

            // Article title
            const title = document.createElement("h3");
            title.textContent = article.title;
            articleElement.appendChild(title);

            // Journal info
            if (article.journal) {
              const journal = document.createElement("p");
              journal.className = "journal-info";
              journal.textContent = `${article.journal}${
                article.publication_date
                  ? " â€¢ " + formatDate(article.publication_date)
                  : ""
              }`;
              articleElement.appendChild(journal);
            }

            // Authors
            if (article.authors && article.authors.length > 0) {
              const authors = document.createElement("p");
              authors.className = "article-meta";
              authors.textContent = `Authors: ${article.authors.join(", ")}`;
              articleElement.appendChild(authors);
            }

            // Abstract
            if (article.abstract) {
              const abstract = document.createElement("p");
              abstract.className = "article-abstract";
              abstract.textContent =
                article.abstract.length > 300
                  ? article.abstract.substring(0, 300) + "..."
                  : article.abstract;
              articleElement.appendChild(abstract);
            }

            // Keywords/mesh terms
            if (article.mesh_terms && article.mesh_terms.length > 0) {
              const meshTermsContainer = document.createElement("div");
              meshTermsContainer.style.marginTop = "10px";

              article.mesh_terms.slice(0, 5).forEach((term) => {
                const badge = document.createElement("span");
                badge.className = "badge";
                badge.textContent = term;
                meshTermsContainer.appendChild(badge);
              });

              articleElement.appendChild(meshTermsContainer);
            }

            // Link to PubMed
            if (article.pmid) {
              const link = document.createElement("p");
              link.style.marginTop = "10px";

              const anchor = document.createElement("a");
              anchor.href = `https://pubmed.ncbi.nlm.nih.gov/${article.pmid}/`;
              anchor.textContent = "View on PubMed";
              anchor.target = "_blank";

              link.appendChild(anchor);
              articleElement.appendChild(link);
            }

            articlesContainer.appendChild(articleElement);
          });

          results.style.display = "block";
        }

        function showError(message) {
          errorMessage.textContent = message;
          errorMessage.style.display = "block";
          loading.style.display = "none";
        }

        function formatDate(dateString) {
          // Simple date formatting
          try {
            const date = new Date(dateString);
            return date.toLocaleDateString("en-US", {
              year: "numeric",
              month: "short",
              day: "numeric",
            });
          } catch (e) {
            return dateString;
          }
        }
      });
    </script>
  </body>
</html>
